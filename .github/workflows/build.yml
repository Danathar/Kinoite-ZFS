name: Build And Promote Main Image

on:
  # Nightly candidate build so we test against current upstream kernel stream.
  schedule:
    - cron:
        "00 06 * * *" # 06:00 UTC daily

  push:
    # Main pipeline runs only from main branch updates.
    branches:
      - main
    # Skip CI for docs/readme-only changes.
    paths-ignore:
      - README.md
      - "**/README.md"
      - docs/**
      - "**/*.md"

  workflow_dispatch:
    # Manual trigger for candidate rebuilds, replay runs, and controlled promotions.
    inputs:
      rebuild_akmods:
        # Override cache detection and force candidate akmods rebuild.
        description: Force rebuild of candidate self-hosted akmods-zfs
        required: false
        default: false
        type: boolean
      promote_to_stable:
        # Allow manual candidate-only test runs by setting false.
        description: Promote candidate artifacts to stable tags after success
        required: false
        default: true
        type: boolean
      use_input_lock:
        # Replay mode: read pinned inputs from lock file instead of floating latest refs.
        description: Use lock file inputs for reproducible replay
        required: false
        default: false
        type: boolean
      lock_file:
        # Repo-relative JSON file containing pinned replay inputs.
        description: Lock file path for replay mode
        required: false
        default: ci/inputs.lock.json
        type: string
      build_container_image:
        # Optional override for akmods job container image (supports digest pinning).
        description: Build container image/ref override (optional)
        required: false
        default: ""
        type: string

concurrency:
  # Keep a single active run per workflow+ref; cancel stale in-flight runs.
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

env:
  # Issue #1/#4 hardening: pin to our forked akmods commit that already
  # contains required ZFS build dependencies.
  AKMODS_UPSTREAM_REPO: https://github.com/Danathar/akmods.git
  AKMODS_UPSTREAM_REF: 9d13b6950811cdaae2e8ab748c85c5da35810ae3

  # Issue #2 mitigation: candidate-first release model.
  # `latest` is updated only by explicit promotion after candidate succeeds.
  IMAGE_NAME: kinoite-zfs
  CANDIDATE_IMAGE_TAG: candidate
  CANDIDATE_AKMODS_REPO: akmods-zfs-candidate
  STABLE_AKMODS_REPO: akmods-zfs

  # Issue #3 controls: default floating inputs (used when replay lock is disabled).
  DEFAULT_BASE_IMAGE: ghcr.io/ublue-os/kinoite-main:latest
  DEFAULT_BUILD_CONTAINER_IMAGE: ghcr.io/ublue-os/devcontainer:latest
  DEFAULT_ZFS_MINOR_VERSION: "2.4"

jobs:
  build-zfs-akmods:
    name: Build Self-Hosted ZFS Akmods (candidate)
    runs-on: ubuntu-24.04
    outputs:
      fedora_version: ${{ steps.inputs.outputs.version }}
      kernel_release: ${{ steps.inputs.outputs.kernel_release }}
      base_image_ref: ${{ steps.inputs.outputs.base_image_ref }}
      base_image_pinned: ${{ steps.inputs.outputs.base_image_pinned }}
      base_image_digest: ${{ steps.inputs.outputs.base_image_digest }}
      build_container_ref: ${{ steps.inputs.outputs.build_container_ref }}
      build_container_pinned: ${{ steps.inputs.outputs.build_container_pinned }}
      build_container_digest: ${{ steps.inputs.outputs.build_container_digest }}
      zfs_minor_version: ${{ steps.inputs.outputs.zfs_minor_version }}
      akmods_upstream_ref: ${{ steps.inputs.outputs.akmods_upstream_ref }}
      use_input_lock: ${{ steps.inputs.outputs.use_input_lock }}
      lock_file_path: ${{ steps.inputs.outputs.lock_file_path }}
    permissions:
      contents: read
      # Needed to push ghcr.io/<owner>/<candidate-akmods-repo>:* images.
      packages: write
    container:
      # Optional manual override supports digest-pinned replay runs.
      image: ${{ github.event.inputs.build_container_image || 'ghcr.io/ublue-os/devcontainer:latest' }}
      # Privileged + mounted container storage are required by upstream akmods build flow.
      options: "--privileged --volume /:/host-sys --volume /var/lib/containers:/var/lib/containers --security-opt seccomp=unconfined --security-opt label=disable --user 0:0"
    steps:
      - uses: actions/checkout@v6

      - name: Resolve build inputs (latest mode or lock replay mode)
        id: inputs
        shell: bash
        env:
          USE_INPUT_LOCK: ${{ github.event.inputs.use_input_lock || 'false' }}
          LOCK_FILE: ${{ github.event.inputs.lock_file || 'ci/inputs.lock.json' }}
          BUILD_CONTAINER_REF: ${{ github.event.inputs.build_container_image || env.DEFAULT_BUILD_CONTAINER_IMAGE }}
          DEFAULT_BASE_IMAGE: ${{ env.DEFAULT_BASE_IMAGE }}
          DEFAULT_ZFS_MINOR_VERSION: ${{ env.DEFAULT_ZFS_MINOR_VERSION }}
          DEFAULT_AKMODS_REF: ${{ env.AKMODS_UPSTREAM_REF }}
        run: |
          ./.github/scripts/main/resolve-build-inputs.sh

      - name: Write build inputs manifest
        shell: bash
        env:
          FEDORA_VERSION: ${{ steps.inputs.outputs.version }}
          KERNEL_RELEASE: ${{ steps.inputs.outputs.kernel_release }}
          BASE_IMAGE_REF: ${{ steps.inputs.outputs.base_image_ref }}
          BASE_IMAGE_PINNED: ${{ steps.inputs.outputs.base_image_pinned }}
          BASE_IMAGE_DIGEST: ${{ steps.inputs.outputs.base_image_digest }}
          BUILD_CONTAINER_REF: ${{ steps.inputs.outputs.build_container_ref }}
          BUILD_CONTAINER_PINNED: ${{ steps.inputs.outputs.build_container_pinned }}
          BUILD_CONTAINER_DIGEST: ${{ steps.inputs.outputs.build_container_digest }}
          ZFS_MINOR_VERSION: ${{ steps.inputs.outputs.zfs_minor_version }}
          AKMODS_UPSTREAM_REF: ${{ steps.inputs.outputs.akmods_upstream_ref }}
          USE_INPUT_LOCK: ${{ steps.inputs.outputs.use_input_lock }}
          LOCK_FILE_PATH: ${{ steps.inputs.outputs.lock_file_path }}
        run: |
          ./.github/scripts/main/write-build-inputs-manifest.sh

      - name: Upload build inputs manifest
        uses: actions/upload-artifact@v4
        with:
          # One manifest per run; use this file to populate ci/inputs.lock.json for replay.
          name: build-inputs-${{ github.run_id }}
          path: artifacts/build-inputs.json

      - name: Check for existing candidate self-hosted zfs akmods image
        id: akmods
        shell: bash
        env:
          FEDORA_VERSION: ${{ steps.inputs.outputs.version }}
          KERNEL_RELEASE: ${{ steps.inputs.outputs.kernel_release }}
          CANDIDATE_AKMODS_REPO: ${{ env.CANDIDATE_AKMODS_REPO }}
          STABLE_AKMODS_REPO: ${{ env.STABLE_AKMODS_REPO }}
        run: |
          ./.github/scripts/main/check-candidate-akmods-cache.sh

      - name: Clone upstream akmods tooling
        # Rebuild when scheduled, manually forced, or candidate cache is missing/stale.
        if: github.event_name == 'schedule' || github.event.inputs.rebuild_akmods == 'true' || steps.akmods.outputs.exists != 'true'
        shell: bash
        env:
          AKMODS_UPSTREAM_REPO: ${{ env.AKMODS_UPSTREAM_REPO }}
          AKMODS_UPSTREAM_REF: ${{ steps.inputs.outputs.akmods_upstream_ref }}
        run: |
          ./.github/scripts/akmods/clone-pinned-akmods.sh

      - name: Configure candidate zfs target in self-hosted namespace
        if: github.event_name == 'schedule' || github.event.inputs.rebuild_akmods == 'true' || steps.akmods.outputs.exists != 'true'
        shell: bash
        env:
          FEDORA_VERSION: ${{ steps.inputs.outputs.version }}
          AKMODS_REPO: ${{ env.CANDIDATE_AKMODS_REPO }}
          AKMODS_DESCRIPTION: Candidate caching layer for pre-built zfs akmod RPMs
        run: |
          ./.github/scripts/akmods/configure-zfs-target.sh

      - name: Build and publish candidate self-hosted zfs akmods image
        if: github.event_name == 'schedule' || github.event.inputs.rebuild_akmods == 'true' || steps.akmods.outputs.exists != 'true'
        shell: bash
        env:
          # `main` follows Fedora desktop kernel stream used by Kinoite main/latest.
          AKMODS_KERNEL: main
          AKMODS_VERSION: ${{ steps.inputs.outputs.version }}
          AKMODS_TARGET: zfs
          # ZFS version is resolved in the input step (default or lock file).
          ZFS_MINOR_VERSION: ${{ steps.inputs.outputs.zfs_minor_version }}
          CI: "1"
          REGISTRY_ACTOR: ${{ github.actor }}
          REGISTRY_TOKEN: ${{ github.token }}
        run: |
          ./.github/scripts/akmods/build-and-publish.sh

  bluebuild-candidate:
    name: Build Candidate Image
    needs: build-zfs-akmods
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Set candidate image tag, base image, and candidate akmods source in recipe
        shell: bash
        env:
          IMAGE_TAG: ${{ env.CANDIDATE_IMAGE_TAG }}
          BASE_IMAGE_PINNED: ${{ needs.build-zfs-akmods.outputs.base_image_pinned }}
          AKMODS_REPO: ${{ env.CANDIDATE_AKMODS_REPO }}
        run: |
          ./.github/scripts/main/configure-candidate-recipe.sh

      - name: Build Candidate Image
        uses: blue-build/github-action@v1.11.0
        with:
          recipe: recipe.yml
          cosign_private_key: ${{ secrets.SIGNING_SECRET }}
          registry_token: ${{ github.token }}
          pr_event_number: ${{ github.event.number }}
          maximize_build_space: true

  promote-stable:
    name: Promote Candidate To Stable
    needs:
      - build-zfs-akmods
      - bluebuild-candidate
    # Automatic promotion on push/schedule. Manual runs can skip promotion.
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.promote_to_stable == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Install skopeo
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Promote candidate image and akmods cache to stable tags
        shell: bash
        env:
          REGISTRY_ACTOR: ${{ github.actor }}
          REGISTRY_TOKEN: ${{ github.token }}
          FEDORA_VERSION: ${{ needs.build-zfs-akmods.outputs.fedora_version }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          CANDIDATE_AKMODS_REPO: ${{ env.CANDIDATE_AKMODS_REPO }}
          STABLE_AKMODS_REPO: ${{ env.STABLE_AKMODS_REPO }}
        run: |
          ./.github/scripts/main/promote-stable.sh
