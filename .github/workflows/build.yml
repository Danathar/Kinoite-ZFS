name: bluebuild
on:
  schedule:
    - cron:
        "00 06 * * *" # build at 06:00 UTC every day
        # (20 minutes after last ublue images start building)
  push:
    paths-ignore: # don't rebuild if only documentation has changed
      - "**.md"

  pull_request:
  workflow_dispatch: # allow manually triggering builds
concurrency:
  # only run one build at a time
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true
jobs:
  build-zfs-akmods:
    name: Build Self-Hosted ZFS Akmods
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write
    container:
      image: ghcr.io/ublue-os/devcontainer:latest
      options: "--privileged --volume /:/host-sys --volume /var/lib/containers:/var/lib/containers --security-opt seccomp=unconfined --security-opt label=disable --user 0:0"
    steps:
      - name: Detect Fedora major version for Kinoite latest
        id: fedora
        shell: bash
        run: |
          set -euo pipefail
          ostree_linux="$(skopeo inspect docker://ghcr.io/ublue-os/kinoite-main:latest --format '{{ index .Labels "ostree.linux" }}')"
          fedora_version="$(sed -E 's/.*fc([0-9]+).*/\1/' <<< "${ostree_linux}")"
          if [[ -z "${fedora_version}" ]]; then
            echo "Failed to detect Fedora version from ostree.linux=${ostree_linux}" >&2
            exit 1
          fi
          echo "version=${fedora_version}" >> "${GITHUB_OUTPUT}"

      - name: Clone upstream akmods tooling
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth 1 https://github.com/ublue-os/akmods.git /tmp/akmods

      - name: Configure zfs target in self-hosted namespace
        shell: bash
        env:
          FEDORA_VERSION: ${{ steps.fedora.outputs.version }}
        run: |
          set -euo pipefail
          cd /tmp/akmods
          IMAGE_ORG="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          export FEDORA_VERSION IMAGE_ORG
          yq -i '
            .images[strenv(FEDORA_VERSION)].main.zfs = {
              "org": strenv(IMAGE_ORG),
              "registry": "ghcr.io",
              "repo": "akmods",
              "transport": "docker://",
              "name": "akmods-zfs",
              "description": "A caching layer for the pre-built zfs akmod RPMs",
              "architecture": ["x86_64"]
            }
          ' images.yaml
          # main+zfs is not in upstream defaults; ensure jq is installed before zfs release parsing.
          sed -i '/^cd \/tmp$/a dnf install -y jq' build_files/zfs/build-kmod-zfs.sh
          # zfs 2.4 source RPM build deps need python3-cffi on Fedora main builds.
          perl -0777 -i -pe 's/RPMS_TO_INSTALL\+=\(\n    akmods/RPMS_TO_INSTALL+=(\n    python3-cffi\n    akmods/' build_files/prep/build-prep.sh

      - name: Build and publish self-hosted zfs akmods image
        shell: bash
        env:
          AKMODS_KERNEL: main
          AKMODS_VERSION: ${{ steps.fedora.outputs.version }}
          AKMODS_TARGET: zfs
          ZFS_MINOR_VERSION: "2.4"
          CI: "1"
          REGISTRY_ACTOR: ${{ github.actor }}
          REGISTRY_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          cd /tmp/akmods
          just build
          just login
          just push
          just manifest

  bluebuild:
    name: Build Custom Image
    needs: build-zfs-akmods
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    strategy:
      fail-fast: false # stop GH from cancelling all matrix builds if one fails
      matrix:
        recipe:
          # !! Add your recipes here
          - recipe.yml
    steps:
      # the build is fully handled by the reusable github action
      - name: Build Custom Image
        uses: blue-build/github-action@v1.11
        with:
          recipe: ${{ matrix.recipe }}
          cosign_private_key: ${{ secrets.SIGNING_SECRET }}
          registry_token: ${{ github.token }}
          pr_event_number: ${{ github.event.number }}

          # enabled by default, disable if your image is small and you want faster builds
          maximize_build_space: true
