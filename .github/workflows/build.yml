name: Build And Promote Main Image

on:
  # Nightly run to check if the newest upstream kernel still builds with ZFS.
  schedule:
    - cron:
        "00 06 * * *" # 06:00 UTC daily

  push:
    # Run this workflow only for updates to `main`.
    branches:
      - main
    # Skip this workflow for docs-only changes.
    paths-ignore:
      - README.md
      - "**/README.md"
      - docs/**
      - "**/*.md"

  workflow_dispatch:
    # Manual run for rebuilds, troubleshooting, and optional publish-to-stable.
    inputs:
      rebuild_akmods:
        # Ignore cache checks and always rebuild akmods.
        description: Force rebuild of candidate self-hosted akmods-zfs
        required: false
        default: false
        type: boolean
      promote_to_stable:
        # Set false to test candidate build without moving `latest`.
        description: Promote candidate artifacts to stable tags after success
        required: false
        default: true
        type: boolean
      use_input_lock:
        # Use values from `ci/inputs.lock.json` instead of moving `latest` tags.
        description: Use lock file inputs so you can rerun with the same base inputs
        required: false
        default: false
        type: boolean
      lock_file:
        # Repo-relative JSON file with pinned input values.
        description: Lock file path for replay mode
        required: false
        default: ci/inputs.lock.json
        type: string
      build_container_image:
        # Optional override for the builder image.
        description: Build container image/ref override (optional)
        required: false
        default: ""
        type: string

concurrency:
  # Keep only one run per branch/workflow; cancel older in-progress runs.
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

env:
  # Use a pinned akmods fork commit that includes required ZFS build deps.
  AKMODS_UPSTREAM_REPO: https://github.com/Danathar/akmods.git
  AKMODS_UPSTREAM_REF: 9d13b6950811cdaae2e8ab748c85c5da35810ae3

  # Candidate-first flow: update `latest` only after candidate succeeds.
  IMAGE_NAME: kinoite-zfs
  CANDIDATE_IMAGE_TAG: candidate
  CANDIDATE_AKMODS_REPO: akmods-zfs-candidate
  STABLE_AKMODS_REPO: akmods-zfs

  # Default moving inputs used when lock mode is off.
  DEFAULT_BASE_IMAGE: ghcr.io/ublue-os/kinoite-main:latest
  DEFAULT_BUILD_CONTAINER_IMAGE: ghcr.io/ublue-os/devcontainer:latest
  DEFAULT_ZFS_MINOR_VERSION: "2.4"

jobs:
  build-zfs-akmods:
    name: Build Self-Hosted ZFS Akmods (candidate)
    runs-on: ubuntu-24.04
    outputs:
      fedora_version: ${{ steps.inputs.outputs.version }}
      kernel_release: ${{ steps.inputs.outputs.kernel_release }}
      base_image_ref: ${{ steps.inputs.outputs.base_image_ref }}
      base_image_name: ${{ steps.inputs.outputs.base_image_name }}
      base_image_tag: ${{ steps.inputs.outputs.base_image_tag }}
      base_image_pinned: ${{ steps.inputs.outputs.base_image_pinned }}
      base_image_digest: ${{ steps.inputs.outputs.base_image_digest }}
      build_container_ref: ${{ steps.inputs.outputs.build_container_ref }}
      build_container_pinned: ${{ steps.inputs.outputs.build_container_pinned }}
      build_container_digest: ${{ steps.inputs.outputs.build_container_digest }}
      zfs_minor_version: ${{ steps.inputs.outputs.zfs_minor_version }}
      akmods_upstream_ref: ${{ steps.inputs.outputs.akmods_upstream_ref }}
      use_input_lock: ${{ steps.inputs.outputs.use_input_lock }}
      lock_file_path: ${{ steps.inputs.outputs.lock_file_path }}
    permissions:
      contents: read
      # Needed to push candidate akmods images.
      packages: write
    container:
      # Can be overridden by manual input.
      image: ${{ github.event.inputs.build_container_image || 'ghcr.io/ublue-os/devcontainer:latest' }}
      # Required for current akmods build tooling.
      options: "--privileged --volume /:/host-sys --volume /var/lib/containers:/var/lib/containers --security-opt seccomp=unconfined --security-opt label=disable --user 0:0"
    steps:
      - uses: actions/checkout@v6

      - name: Resolve build inputs (latest mode or lock replay mode)
        id: inputs
        shell: bash
        env:
          USE_INPUT_LOCK: ${{ github.event.inputs.use_input_lock || 'false' }}
          LOCK_FILE: ${{ github.event.inputs.lock_file || 'ci/inputs.lock.json' }}
          BUILD_CONTAINER_REF: ${{ github.event.inputs.build_container_image || env.DEFAULT_BUILD_CONTAINER_IMAGE }}
          DEFAULT_BASE_IMAGE: ${{ env.DEFAULT_BASE_IMAGE }}
          DEFAULT_ZFS_MINOR_VERSION: ${{ env.DEFAULT_ZFS_MINOR_VERSION }}
          DEFAULT_AKMODS_REF: ${{ env.AKMODS_UPSTREAM_REF }}
        run: |
          ./.github/scripts/main/resolve-build-inputs.sh

      - name: Write build inputs manifest
        shell: bash
        env:
          FEDORA_VERSION: ${{ steps.inputs.outputs.version }}
          KERNEL_RELEASE: ${{ steps.inputs.outputs.kernel_release }}
          BASE_IMAGE_REF: ${{ steps.inputs.outputs.base_image_ref }}
          BASE_IMAGE_NAME: ${{ steps.inputs.outputs.base_image_name }}
          BASE_IMAGE_TAG: ${{ steps.inputs.outputs.base_image_tag }}
          BASE_IMAGE_PINNED: ${{ steps.inputs.outputs.base_image_pinned }}
          BASE_IMAGE_DIGEST: ${{ steps.inputs.outputs.base_image_digest }}
          BUILD_CONTAINER_REF: ${{ steps.inputs.outputs.build_container_ref }}
          BUILD_CONTAINER_PINNED: ${{ steps.inputs.outputs.build_container_pinned }}
          BUILD_CONTAINER_DIGEST: ${{ steps.inputs.outputs.build_container_digest }}
          ZFS_MINOR_VERSION: ${{ steps.inputs.outputs.zfs_minor_version }}
          AKMODS_UPSTREAM_REF: ${{ steps.inputs.outputs.akmods_upstream_ref }}
          USE_INPUT_LOCK: ${{ steps.inputs.outputs.use_input_lock }}
          LOCK_FILE_PATH: ${{ steps.inputs.outputs.lock_file_path }}
        run: |
          ./.github/scripts/main/write-build-inputs-manifest.sh

      - name: Upload build inputs manifest
        uses: actions/upload-artifact@v6
        with:
          # One input snapshot per run. You can copy it into `ci/inputs.lock.json`.
          name: build-inputs-${{ github.run_id }}
          path: artifacts/build-inputs.json

      - name: Check for existing candidate self-hosted zfs akmods image
        id: akmods
        shell: bash
        env:
          FEDORA_VERSION: ${{ steps.inputs.outputs.version }}
          KERNEL_RELEASE: ${{ steps.inputs.outputs.kernel_release }}
          CANDIDATE_AKMODS_REPO: ${{ env.CANDIDATE_AKMODS_REPO }}
          STABLE_AKMODS_REPO: ${{ env.STABLE_AKMODS_REPO }}
        run: |
          ./.github/scripts/main/check-candidate-akmods-cache.sh

      - name: Clone upstream akmods tooling
        # Rebuild when scheduled, manually forced, or cache is missing/outdated.
        if: github.event_name == 'schedule' || github.event.inputs.rebuild_akmods == 'true' || steps.akmods.outputs.exists != 'true'
        shell: bash
        env:
          AKMODS_UPSTREAM_REPO: ${{ env.AKMODS_UPSTREAM_REPO }}
          AKMODS_UPSTREAM_REF: ${{ steps.inputs.outputs.akmods_upstream_ref }}
        run: |
          ./.github/scripts/akmods/clone-pinned-akmods.sh

      - name: Configure candidate zfs target in self-hosted namespace
        if: github.event_name == 'schedule' || github.event.inputs.rebuild_akmods == 'true' || steps.akmods.outputs.exists != 'true'
        shell: bash
        env:
          FEDORA_VERSION: ${{ steps.inputs.outputs.version }}
          KERNEL_RELEASE: ${{ steps.inputs.outputs.kernel_release }}
          AKMODS_REPO: ${{ env.CANDIDATE_AKMODS_REPO }}
          AKMODS_DESCRIPTION: Candidate caching layer for pre-built zfs akmod RPMs
        run: |
          ./.github/scripts/akmods/configure-zfs-target.sh

      - name: Build and publish candidate self-hosted zfs akmods image
        if: github.event_name == 'schedule' || github.event.inputs.rebuild_akmods == 'true' || steps.akmods.outputs.exists != 'true'
        shell: bash
        env:
          # `main` follows the Fedora desktop kernel stream used by Kinoite main/latest.
          AKMODS_KERNEL: main
          AKMODS_VERSION: ${{ steps.inputs.outputs.version }}
          # Build akmods for the exact kernel chosen in input resolution.
          KERNEL_RELEASE: ${{ steps.inputs.outputs.kernel_release }}
          AKMODS_TARGET: zfs
          # ZFS version comes from input resolution (default or lock file).
          ZFS_MINOR_VERSION: ${{ steps.inputs.outputs.zfs_minor_version }}
          CI: "1"
          REGISTRY_ACTOR: ${{ github.actor }}
          REGISTRY_TOKEN: ${{ github.token }}
        run: |
          ./.github/scripts/akmods/build-and-publish.sh

  bluebuild-candidate:
    name: Build Candidate Image
    # Safety gate:
    # This job must pass before stable tags are allowed to move.
    # If candidate build fails, users stay on last known-good `latest`.
    needs: build-zfs-akmods
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Set kernel-matched akmods source and pin base tag in recipe
        shell: bash
        env:
          KERNEL_RELEASE: ${{ needs.build-zfs-akmods.outputs.kernel_release }}
          BASE_IMAGE_NAME: ${{ needs.build-zfs-akmods.outputs.base_image_name }}
          BASE_IMAGE_TAG: ${{ needs.build-zfs-akmods.outputs.base_image_tag }}
          # Candidate image build pulls from these akmods tags.
          AKMODS_REPO: ${{ env.STABLE_AKMODS_REPO }}
        run: |
          ./.github/scripts/main/configure-candidate-recipe.sh

      - name: Build Candidate Image
        uses: blue-build/github-action@v1.11.0
        with:
          recipe: recipe.yml
          cosign_private_key: ${{ secrets.SIGNING_SECRET }}
          registry_token: ${{ github.token }}
          pr_event_number: ${{ github.event.number }}
          maximize_build_space: true
          # Keep file edits from the previous step. Action checkout would reset them.
          skip_checkout: true

  promote-stable:
    name: Promote Candidate To Stable
    # Safety model:
    # Promotion is a separate job that runs only after both candidate jobs succeed.
    # That keeps broken candidate outputs from replacing stable tags.
    needs:
      - build-zfs-akmods
      - bluebuild-candidate
    # Push/schedule runs promote automatically. Manual runs can skip promotion.
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.promote_to_stable == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6

      - name: Install skopeo
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Promote candidate image and akmods cache to stable tags
        shell: bash
        env:
          REGISTRY_ACTOR: ${{ github.actor }}
          REGISTRY_TOKEN: ${{ github.token }}
          FEDORA_VERSION: ${{ needs.build-zfs-akmods.outputs.fedora_version }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          CANDIDATE_AKMODS_REPO: ${{ env.CANDIDATE_AKMODS_REPO }}
          STABLE_AKMODS_REPO: ${{ env.STABLE_AKMODS_REPO }}
        run: |
          ./.github/scripts/main/promote-stable.sh
