name: Build Branch Image

on:
  push:
    # Build branch-tagged images for non-main branches only.
    branches-ignore:
      - main
      - dependabot/**
    # Skip CI for docs/readme-only changes.
    paths-ignore:
      - README.md
      - "**/README.md"
      - docs/**
      - "**/*.md"

  workflow_dispatch:
    # Manual trigger for branch build/testing.

concurrency:
  # One active run per workflow+branch; newer pushes cancel stale runs.
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  prepare-branch-metadata:
    name: Compute Branch Tags
    runs-on: ubuntu-latest
    outputs:
      akmods_public_tag_prefix: ${{ steps.branch.outputs.akmods_public_tag_prefix }}
    steps:
      - uses: actions/checkout@v6

      - name: Compute branch-safe public alias tag prefix
        id: branch
        shell: bash
        run: |
          python3 -m ci_tools.cli beta-compute-branch-metadata

  build-zfs-akmods:
    name: Build Self-Hosted ZFS Akmods (branch)
    needs: prepare-branch-metadata
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      # Needed to copy/publish branch alias tags in ghcr.io/<owner>/akmods-zfs-candidate:*.
      packages: write
    container:
      image: ghcr.io/ublue-os/devcontainer:latest
      options: "--privileged --volume /:/host-sys --volume /var/lib/containers:/var/lib/containers --security-opt seccomp=unconfined --security-opt label=disable --user 0:0"
    steps:
      - uses: actions/checkout@v6

      - name: Detect Fedora major version for Kinoite latest
        id: fedora
        shell: bash
        run: |
          python3 -m ci_tools.cli beta-detect-fedora-version

      - name: Check for existing shared self-hosted zfs akmods image
        id: akmods
        shell: bash
        env:
          FEDORA_VERSION: ${{ steps.fedora.outputs.version }}
          KERNEL_RELEASE: ${{ steps.fedora.outputs.kernel_release }}
          # Upstream akmods publish currently writes zfs tags to `akmods-zfs`.
          # Branch workflow intentionally treats this as read-only input.
          AKMODS_REPO: akmods-zfs
        run: |
          python3 -m ci_tools.cli beta-check-branch-akmods-cache

      - name: Stop when shared akmods source is missing or stale
        # Branch workflow is intentionally read-only for shared akmods tags.
        # If the shared source cache is missing/stale, fail closed and rebuild it
        # from the main workflow instead of mutating shared tags from a test branch.
        if: steps.akmods.outputs.exists != 'true'
        shell: bash
        env:
          FEDORA_VERSION: ${{ steps.fedora.outputs.version }}
          KERNEL_RELEASE: ${{ steps.fedora.outputs.kernel_release }}
        run: |
          echo "Shared akmods source tag akmods-zfs:main-${FEDORA_VERSION} is missing or stale for kernel ${KERNEL_RELEASE}." >&2
          echo "Run main workflow (Build And Promote Main Image) with rebuild_akmods=true, then rerun this branch workflow." >&2
          exit 1

      - name: Publish branch cache alias in candidate repo
        # Compose step means the final image build step below (`Build Custom Image`).
        # That compose step runs in a separate build environment that may not be able to
        # read every container package/tag path anonymously.
        # Important: source-code repo visibility and container package visibility
        # are separate settings. A public code repo can still have package tags
        # that require authentication in some build contexts.
        # "Branch-scoped" means the destination tag includes the branch name.
        # We copy from shared source tag to a branch-scoped tag in candidate repo
        # so compose can pull reliably without touching stable tags.
        shell: bash
        env:
          FEDORA_VERSION: ${{ steps.fedora.outputs.version }}
          SOURCE_AKMODS_REPO: akmods-zfs
          DEST_AKMODS_REPO: akmods-zfs-candidate
          DEST_TAG_PREFIX: ${{ needs.prepare-branch-metadata.outputs.akmods_public_tag_prefix }}
          REGISTRY_ACTOR: ${{ github.actor }}
          REGISTRY_TOKEN: ${{ github.token }}
        run: |
          python3 -m ci_tools.cli beta-publish-branch-akmods-alias

  bluebuild:
    name: Build Custom Image (branch)
    needs:
      - prepare-branch-metadata
      - build-zfs-akmods
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Set branch akmods source in recipe
        shell: bash
        env:
          AKMODS_REPO: akmods-zfs-candidate
          AKMODS_TAG_PREFIX: ${{ needs.prepare-branch-metadata.outputs.akmods_public_tag_prefix }}
        run: |
          python3 -m ci_tools.cli beta-configure-branch-recipe

      - name: Build Custom Image
        uses: blue-build/github-action@v1.11.0
        with:
          recipe: recipe.yml
          cosign_private_key: ${{ secrets.SIGNING_SECRET }}
          registry_token: ${{ github.token }}
          pr_event_number: ${{ github.event.number }}
          maximize_build_space: true
          # Keep recipe/containerfile edits from the previous step.
          skip_checkout: true
