name: Build Branch Image

on:
  push:
    # Build branch-tagged images for non-main branches only.
    branches-ignore:
      - main
      - dependabot/**
    # Skip CI for docs/readme-only changes.
    paths-ignore:
      - README.md
      - "**/README.md"
      - docs/**
      - "**/*.md"

  workflow_dispatch:
    # Manual trigger for branch rebuild/testing.
    inputs:
      rebuild_akmods:
        description: Force rebuild of branch-scoped self-hosted akmods-zfs
        required: false
        default: false
        type: boolean

concurrency:
  # One active run per workflow+branch; newer pushes cancel stale runs.
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

env:
  # Issue #1/#4 hardening:
  # Pin to our forked akmods commit so branch tests use the same curated source
  # as main and avoid runtime patching drift.
  AKMODS_UPSTREAM_REPO: https://github.com/Danathar/akmods.git
  AKMODS_UPSTREAM_REF: 9d13b6950811cdaae2e8ab748c85c5da35810ae3

jobs:
  prepare-branch-metadata:
    name: Compute Branch Tags
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.branch.outputs.image_tag }}
      akmods_repo: ${{ steps.branch.outputs.akmods_repo }}
    steps:
      - name: Compute branch-safe image and akmods names
        id: branch
        shell: bash
        run: |
          set -euo pipefail
          branch="${GITHUB_REF_NAME}"

          # Sanitize branch for OCI tag/repo compatibility:
          # - lowercase
          # - replace unsupported chars with '-'
          # - trim leading/trailing separators
          safe="$(echo "${branch}" \
            | tr '[:upper:]' '[:lower:]' \
            | sed -E 's#[^a-z0-9._-]+#-#g; s#^-+##; s#-+$##')"

          if [[ -z "${safe}" ]]; then
            safe="branch"
          fi

          # Keep tag/repo names bounded to avoid registry/path edge-cases.
          image_tag="beta-${safe}"
          image_tag="${image_tag:0:120}"
          image_tag="${image_tag%-}"

          akmods_repo="akmods-zfs-${safe}"
          akmods_repo="${akmods_repo:0:120}"
          akmods_repo="${akmods_repo%-}"

          if [[ -z "${image_tag}" ]]; then
            image_tag="beta-branch"
          fi
          if [[ -z "${akmods_repo}" ]]; then
            akmods_repo="akmods-zfs-branch"
          fi

          echo "image_tag=${image_tag}" >> "${GITHUB_OUTPUT}"
          echo "akmods_repo=${akmods_repo}" >> "${GITHUB_OUTPUT}"
          echo "Branch image tag: ${image_tag}"
          echo "Branch akmods repo: ${akmods_repo}"

  build-zfs-akmods:
    name: Build Self-Hosted ZFS Akmods (branch)
    needs: prepare-branch-metadata
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      # Needed to push ghcr.io/<owner>/<branch-akmods-repo>:* images.
      packages: write
    container:
      image: ghcr.io/ublue-os/devcontainer:latest
      options: "--privileged --volume /:/host-sys --volume /var/lib/containers:/var/lib/containers --security-opt seccomp=unconfined --security-opt label=disable --user 0:0"
    steps:
      - name: Detect Fedora major version for Kinoite latest
        id: fedora
        shell: bash
        run: |
          set -euo pipefail
          ostree_linux="$(skopeo inspect docker://ghcr.io/ublue-os/kinoite-main:latest --format '{{ index .Labels "ostree.linux" }}')"
          fedora_version="$(sed -E 's/.*fc([0-9]+).*/\1/' <<< "${ostree_linux}")"
          if [[ -z "${fedora_version}" ]]; then
            echo "Failed to detect Fedora version from ostree.linux=${ostree_linux}" >&2
            exit 1
          fi
          echo "version=${fedora_version}" >> "${GITHUB_OUTPUT}"
          echo "kernel_release=${ostree_linux}" >> "${GITHUB_OUTPUT}"

      - name: Check for existing branch-scoped self-hosted zfs akmods image
        id: akmods
        shell: bash
        env:
          FEDORA_VERSION: ${{ steps.fedora.outputs.version }}
          KERNEL_RELEASE: ${{ steps.fedora.outputs.kernel_release }}
          AKMODS_REPO: ${{ needs.prepare-branch-metadata.outputs.akmods_repo }}
        run: |
          set -euo pipefail
          IMAGE_ORG="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          AKMODS_IMAGE="ghcr.io/${IMAGE_ORG}/${AKMODS_REPO}:main-${FEDORA_VERSION}"

          # Branch builds intentionally use a branch-specific akmods repo name.
          # This keeps branch testing isolated from main cache tags.
          if skopeo inspect "docker://${AKMODS_IMAGE}" >/dev/null 2>&1; then
            workdir="$(mktemp -d)"
            trap 'rm -rf "${workdir}"' EXIT
            skopeo copy --retry-times 3 "docker://${AKMODS_IMAGE}" "dir:${workdir}/akmods" >/dev/null
            mapfile -t layer_files < <(
              jq -r '.layers[]?.digest // empty' "${workdir}/akmods/manifest.json" \
                | sed -E "s#^sha256:#${workdir}/akmods/#"
            )
            for layer in "${layer_files[@]}"; do
              tar -xf "${layer}" -C "${workdir}"
            done
            if find "${workdir}/rpms/kmods/zfs" -maxdepth 1 -type f -name "kmod-zfs-${KERNEL_RELEASE}-*.rpm" | grep -q .; then
              echo "exists=true" >> "${GITHUB_OUTPUT}"
              echo "Found matching ${AKMODS_IMAGE} kmod for kernel ${KERNEL_RELEASE}; akmods rebuild can be skipped."
            else
              echo "exists=false" >> "${GITHUB_OUTPUT}"
              echo "Cached ${AKMODS_IMAGE} is present but missing kmod for kernel ${KERNEL_RELEASE}; akmods rebuild is required."
            fi
          else
            echo "exists=false" >> "${GITHUB_OUTPUT}"
            echo "No existing ${AKMODS_IMAGE}; akmods rebuild is required."
          fi

      - name: Clone upstream akmods tooling
        # Rebuild when manually forced or when branch cache is missing/stale.
        if: github.event.inputs.rebuild_akmods == 'true' || steps.akmods.outputs.exists != 'true'
        shell: bash
        env:
          AKMODS_UPSTREAM_REPO: ${{ env.AKMODS_UPSTREAM_REPO }}
          AKMODS_UPSTREAM_REF: ${{ env.AKMODS_UPSTREAM_REF }}
        run: |
          set -euo pipefail
          rm -rf /tmp/akmods
          mkdir -p /tmp/akmods
          cd /tmp/akmods

          # Fetch exactly one pinned commit (no floating branch refs).
          git init .
          git remote add origin "${AKMODS_UPSTREAM_REPO}"
          git fetch --depth 1 origin "${AKMODS_UPSTREAM_REF}"
          git checkout --detach FETCH_HEAD

          resolved_ref="$(git rev-parse HEAD)"
          if [[ "${resolved_ref}" != "${AKMODS_UPSTREAM_REF}" ]]; then
            echo "Pinned ref mismatch: expected ${AKMODS_UPSTREAM_REF}, got ${resolved_ref}" >&2
            exit 1
          fi
          echo "Using pinned akmods ref: ${resolved_ref}"

      - name: Configure zfs target in branch-scoped namespace
        if: github.event.inputs.rebuild_akmods == 'true' || steps.akmods.outputs.exists != 'true'
        shell: bash
        env:
          FEDORA_VERSION: ${{ steps.fedora.outputs.version }}
          AKMODS_REPO: ${{ needs.prepare-branch-metadata.outputs.akmods_repo }}
        run: |
          set -euo pipefail
          cd /tmp/akmods
          IMAGE_ORG="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          export FEDORA_VERSION IMAGE_ORG AKMODS_REPO

          # Publish branch cache under a branch-unique repo name to avoid clobbering main cache images.
          yq -i '
            .images[strenv(FEDORA_VERSION)].main.zfs = {
              "org": strenv(IMAGE_ORG),
              "registry": "ghcr.io",
              "repo": "akmods",
              "transport": "docker://",
              "name": strenv(AKMODS_REPO),
              "description": "A branch-scoped caching layer for pre-built zfs akmod RPMs",
              "architecture": ["x86_64"]
            }
          ' images.yaml

      - name: Build and publish branch-scoped self-hosted zfs akmods image
        if: github.event.inputs.rebuild_akmods == 'true' || steps.akmods.outputs.exists != 'true'
        shell: bash
        env:
          AKMODS_KERNEL: main
          AKMODS_VERSION: ${{ steps.fedora.outputs.version }}
          AKMODS_TARGET: zfs
          ZFS_MINOR_VERSION: "2.4"
          CI: "1"
          REGISTRY_ACTOR: ${{ github.actor }}
          REGISTRY_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          cd /tmp/akmods
          just build
          just login
          just push
          just manifest

  bluebuild:
    name: Build Custom Image (branch)
    needs:
      - prepare-branch-metadata
      - build-zfs-akmods
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Set branch image tag and branch akmods source in recipe
        shell: bash
        env:
          IMAGE_TAG: ${{ needs.prepare-branch-metadata.outputs.image_tag }}
          AKMODS_REPO: ${{ needs.prepare-branch-metadata.outputs.akmods_repo }}
        run: |
          set -euo pipefail
          IMAGE_ORG="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"

          # Branch image tag prevents overwriting the default `latest` tag on main images.
          sed -i -E "s/^image-version:.*/image-version: ${IMAGE_TAG}/" recipes/recipe.yml

          # Branch akmods repo prevents branch runs from overwriting main akmods cache images.
          sed -i -E "s#^[[:space:]]*AKMODS_IMAGE=.*#        AKMODS_IMAGE=\"ghcr.io/${IMAGE_ORG}/${AKMODS_REPO}:main-\\\${FEDORA_VERSION}\"#" recipes/recipe.yml

          # Emit effective recipe values for traceability/debugging in build logs.
          grep -n '^image-version:' recipes/recipe.yml
          grep -n 'AKMODS_IMAGE=' recipes/recipe.yml

      - name: Build Custom Image
        uses: blue-build/github-action@v1.11.0
        with:
          recipe: recipe.yml
          cosign_private_key: ${{ secrets.SIGNING_SECRET }}
          registry_token: ${{ github.token }}
          pr_event_number: ${{ github.event.number }}
          maximize_build_space: true
